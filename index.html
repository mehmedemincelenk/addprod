<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hızlı Ürün Yükle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.google
    s.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b; /* Zinc 950 */
            color: white;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
            touch-action: none;
        }

        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }

        #camera-feed { transform: scaleX(1); }

        /* Kayıt Animasyonu */
        .recording-pulse {
            animation: pulse-red 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body class="flex flex-col h-[100dvh] w-full relative">

    <!-- BAŞLANGIÇ EKRANI -->
    <div id="start-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-[#09090b] text-white p-8 text-center">
        <div class="w-24 h-24 bg-zinc-800/50 rounded-full flex items-center justify-center mb-8 shadow-2xl border border-white/5 relative">
            <div class="absolute inset-0 rounded-full bg-blue-500/10 blur-xl"></div>
            <i class="ph ph-camera text-4xl text-blue-400 relative z-10"></i>
        </div>
        <h3 class="text-3xl font-bold mb-3 tracking-tight">Hoş Geldiniz</h3>
        <p class="text-zinc-400 mb-10 max-w-xs text-sm leading-relaxed font-medium">Hızlı ürün yüklemek için kamera ve mikrofona erişim izni verin.</p>
        <button onclick="initApp()" class="w-full max-w-[200px] py-4 bg-white text-black rounded-2xl font-bold text-lg hover:bg-zinc-200 active:scale-95 transition-all flex items-center justify-center gap-2 shadow-lg shadow-white/5">
            Başla
            <i class="ph ph-arrow-right font-bold"></i>
        </button>
    </div>

    <!-- 1. ÜST HEADER -->
    <header class="absolute top-0 left-0 right-0 z-30 safe-pt p-4 flex justify-between items-center pointer-events-none">
        <button onclick="toggleHelpModal()" class="pointer-events-auto w-10 h-10 rounded-full glass flex items-center justify-center text-white/80 active:bg-white/10 transition-colors">
            <i class="ph ph-question text-xl"></i>
        </button>

        <div class="glass px-4 py-1.5 rounded-full">
            <span class="text-xs font-semibold text-white/90 tracking-wide uppercase">Ürün Yükle</span>
        </div>

        <button onclick="switchCamera()" class="pointer-events-auto w-10 h-10 rounded-full glass flex items-center justify-center text-white/80 active:bg-white/10 transition-colors">
            <i class="ph ph-arrows-clockwise text-xl"></i>
        </button>
    </header>

    <!-- 2. KAMERA VİZÖRÜ (2:3) -->
    <div class="flex-1 relative flex flex-col justify-center items-center overflow-hidden bg-[#09090b]">
        <div class="relative w-full aspect-[2/3] max-h-[85vh] bg-zinc-900 rounded-[2rem] overflow-hidden shadow-2xl mx-4 border border-white/5">
            <video id="camera-feed" autoplay playsinline muted class="w-full h-full object-cover opacity-90"></video>
            
            <div id="camera-permission-warning" class="hidden absolute inset-0 flex flex-col items-center justify-center p-6 text-center bg-zinc-900/95 backdrop-blur-sm z-30">
                <i class="ph ph-lock-key text-4xl text-zinc-500 mb-4"></i>
                <h3 class="text-white font-bold mb-2">İzin Gerekli</h3>
                <p class="text-xs text-zinc-400 mb-6">Ayarlardan kamera ve mikrofonu açın.</p>
                <button onclick="initApp()" class="px-6 py-2 bg-white text-black rounded-full font-bold text-xs">Tekrar Dene</button>
            </div>

            <div class="absolute bottom-4 left-4 right-4 flex justify-between items-end">
                <div id="gallery-wrapper" class="hidden">
                    <div id="gallery-strip" class="flex gap-2 overflow-x-auto hide-scrollbar p-1"></div>
                </div>
                
                <button onclick="takePhoto()" class="ml-auto w-14 h-14 rounded-full border-[3px] border-white/80 bg-white/20 backdrop-blur-sm flex items-center justify-center active:scale-95 transition-transform shadow-lg">
                    <div class="w-10 h-10 bg-white rounded-full"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- 3. ALT KONTROL PANELİ -->
    <div class="bg-[#09090b] text-white pt-6 px-6 pb-8 safe-pb z-20 flex flex-col gap-6 relative rounded-t-[2rem] border-t border-white/5">
        <div class="absolute top-3 left-1/2 -translate-x-1/2 w-12 h-1 bg-zinc-800 rounded-full"></div>

        <div class="flex items-center gap-5 mt-2 justify-center">
            <button id="record-btn" onclick="toggleRecording()" class="shrink-0 w-20 h-20 bg-red-600 text-white rounded-[2rem] flex items-center justify-center shadow-lg shadow-red-900/20 active:scale-95 transition-all touch-none relative overflow-hidden group select-none">
                <div class="absolute inset-0 bg-gradient-to-tr from-red-600 to-red-500"></div>
                <i id="mic-icon" class="ph ph-microphone text-3xl z-10 relative text-white"></i>
            </button>

            <div class="flex-1 max-w-[200px] flex flex-col justify-center h-20">
                <div class="flex justify-between items-center mb-1.5">
                    <span id="recorder-prompt" class="text-[10px] font-bold text-zinc-400 uppercase tracking-wider">DOKUN VE KONUŞ</span>
                    <div id="recording-indicator" class="hidden flex items-center gap-1.5 px-2 py-0.5 bg-red-500/10 rounded-full border border-red-500/20">
                        <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span>
                        <span class="text-[9px] font-bold text-red-500">KAYITTA</span>
                    </div>
                </div>
                <p id="live-transcript" class="text-sm text-zinc-300 font-medium leading-snug line-clamp-2 transition-colors">"Ahmet Tekstil, Zara oversize gömlek, Mavi M beden, 300 TL..."</p>
            </div>
        </div>
    </div>

    <!-- GİZLİ CANVAS -->
    <canvas id="capture-canvas" class="hidden"></canvas>

    <!-- YARDIM MODALI -->
    <div id="help-modal" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center p-4 sm:p-6 bg-black/80 backdrop-blur-sm transition-opacity" onclick="toggleHelpModal()">
        <div class="bg-zinc-900 border border-white/10 w-full max-w-sm rounded-[2rem] p-6 text-left shadow-2xl relative transform transition-transform overflow-y-auto max-h-[80vh] custom-scrollbar" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-zinc-900 z-10 pb-2 border-b border-white/5">
                <h3 class="text-xl font-bold text-white">Neler Söylemelisin?</h3>
                <button onclick="toggleHelpModal()" class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center text-zinc-400 hover:text-white"><i class="ph ph-x"></i></button>
            </div>
            
            <div class="space-y-4">
                <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-full bg-indigo-500/10 flex items-center justify-center shrink-0"><i class="ph ph-storefront text-indigo-400 text-xl"></i></div>
                    <div><p class="text-sm font-bold text-white">Tedarikçi Adı</p><p class="text-xs text-zinc-400">"Ben Ahmet Tekstil"</p></div>
                </div>
                <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center shrink-0"><i class="ph ph-tag text-blue-400 text-xl"></i></div>
                    <div><p class="text-sm font-bold text-white">Marka & Ürün</p><p class="text-xs text-zinc-400">"Zara Sweatshirt", "Mavi Pantolon"</p></div>
                </div>
                <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-full bg-pink-500/10 flex items-center justify-center shrink-0"><i class="ph ph-gender-intersex text-pink-400 text-xl"></i></div>
                    <div><p class="text-sm font-bold text-white">Cinsiyet</p><p class="text-xs text-zinc-400">"Kadın", "Erkek", "Unisex"</p></div>
                </div>
                <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center shrink-0"><i class="ph ph-currency-try text-green-400 text-xl"></i></div>
                    <div><p class="text-sm font-bold text-white">Fiyat</p><p class="text-xs text-zinc-400">"300 Lira"</p></div>
                </div>
                <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-full bg-orange-500/10 flex items-center justify-center shrink-0"><i class="ph ph-warning-circle text-orange-400 text-xl"></i></div>
                    <div><p class="text-sm font-bold text-white">Kusur Durumu</p><p class="text-xs text-zinc-400">"Defosu yok", "Etiketi kesik"</p></div>
                </div>
            </div>
            
            <button onclick="toggleHelpModal()" class="w-full mt-8 py-3 bg-white text-black rounded-xl font-bold text-sm hover:bg-zinc-200 transition-colors">Tamamdır</button>
        </div>
    </div>

    <!-- LOADING UI -->
    <div id="loading-overlay" class="fixed inset-0 bg-[#09090b]/90 z-[60] hidden flex flex-col items-center justify-center text-white p-6 text-center backdrop-blur-md">
        <div class="relative mb-6">
            <div class="w-16 h-16 border-4 border-zinc-800 border-t-blue-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center"><i class="ph ph-sparkle text-blue-500 animate-pulse"></i></div>
        </div>
        <h3 class="text-xl font-bold mb-2" id="loading-title">Yapay Zeka Çalışıyor</h3>
        <p class="text-sm text-zinc-400 animate-pulse" id="loading-text">Ses ve görüntü işleniyor...</p>
    </div>

    <!-- SUCCESS MODAL (Onay Ekranı - Renk ve Beden Ayrıldı) -->
    <div id="success-modal" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center p-4 sm:p-6 bg-black/90 backdrop-blur-sm">
        <div class="absolute inset-0" onclick="resetApp()"></div>
        <div class="bg-zinc-900 border border-white/10 w-full max-w-sm rounded-[2rem] p-5 relative z-10 shadow-2xl flex flex-col max-h-[85vh]">
            <div class="text-center mb-5 shrink-0">
                <div class="w-12 h-12 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center mx-auto mb-3"><i class="ph ph-check text-2xl font-bold"></i></div>
                <h3 class="text-lg font-bold text-white">Hazır!</h3>
            </div>
            <div class="flex-1 overflow-y-auto space-y-3 mb-6 pr-1 custom-scrollbar">
                <div class="bg-black/40 p-3 rounded-xl border border-white/5"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Ürün Başlığı</p><p id="res-baslik" class="text-sm font-bold text-white leading-tight">-</p></div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-black/40 p-3 rounded-xl border border-white/5"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Marka</p><p id="res-tedarikci-marka" class="text-sm text-zinc-200 truncate">-</p></div>
                    <div class="bg-black/40 p-3 rounded-xl border border-white/5"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Kategori</p><p id="res-kategori" class="text-sm text-zinc-200 truncate">-</p></div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-black/40 p-3 rounded-xl border border-white/5">
                        <p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Renk</p>
                        <p id="res-renk" class="text-sm text-zinc-200 truncate">-</p>
                    </div>
                    <div class="bg-black/40 p-3 rounded-xl border border-white/5">
                        <p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Beden</p>
                        <p id="res-beden" class="text-sm text-zinc-200 truncate">-</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-green-500/10 p-3 rounded-xl border border-green-500/20"><p class="text-[10px] text-green-500 uppercase font-bold mb-1">Satış Fiyatı</p><p id="res-fiyat" class="text-lg font-bold text-green-400">-</p></div>
                    <div class="bg-black/40 p-3 rounded-xl border border-white/5"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Piyasa</p><p id="res-piyasa-fiyat" class="text-sm text-zinc-400 line-through">-</p></div>
                </div>
                <div class="bg-black/40 p-3 rounded-xl border border-white/5"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Açıklama</p><p id="res-aciklama" class="text-xs text-zinc-300 italic leading-relaxed">-</p></div>
                
                <!-- Gizli Veriler -->
                <div class="hidden"><span id="res-kalip"></span><span id="res-stok"></span><span id="res-kusur"></span></div>
            </div>
            <div class="space-y-3 shrink-0">
                <button onclick="sendDataToWebhook()" id="final-send-btn" class="w-full bg-white text-black py-4 rounded-xl font-bold text-base shadow-lg hover:bg-zinc-200 active:scale-95 transition-all flex items-center justify-center gap-2"><span>Onayla ve Gönder</span><i class="ph ph-paper-plane-tilt font-bold"></i></button>
                <button onclick="resetApp()" class="w-full bg-transparent text-zinc-400 py-3 rounded-xl font-medium text-sm hover:text-white transition-colors">İptal Et</button>
            </div>
        </div>
    </div>

    <!-- BAŞARILI BİLDİRİM EKRANI -->
    <div id="email-success-overlay" class="fixed inset-0 bg-[#09090b]/95 z-[70] hidden flex flex-col items-center justify-center text-white p-6 text-center backdrop-blur-md">
        <div class="w-24 h-24 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center mb-6 shadow-[0_0_40px_rgba(74,222,128,0.2)] scale-110">
            <i class="ph ph-check text-5xl font-bold"></i>
        </div>
        <h3 class="text-3xl font-bold mb-2 tracking-tight">Gönderildi!</h3>
        <p class="text-zinc-400 mb-8 text-sm">Ürün Airtable listesine eklendi.</p>
        <button onclick="resetApp()" class="px-8 py-3 bg-white text-black rounded-full font-bold shadow-lg hover:bg-zinc-200 transition-colors">Sıradaki Ürün</button>
    </div>

    <!-- ERROR TOAST -->
    <div id="error-toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-red-500 text-white px-5 py-2.5 rounded-full shadow-2xl z-[80] hidden transition-all transform -translate-y-full opacity-0 flex items-center gap-2 border border-red-400 max-w-[90%]">
        <i class="ph ph-warning-circle text-lg shrink-0"></i>
        <span id="error-message" class="text-xs font-bold truncate">Hata oluştu</span>
    </div>

    <script>
        // =========================================================
        const API_ANAHTARI = "";
        const WEBHOOK_URL = "https://hook.eu1.make.com/uav81dlsk6p0ibimh6t3jmg5o4xcowhi";
        // =========================================================

        let photos = []; let stream = null; let facingMode = "environment"; let mediaRecorder = null; let audioChunks = []; let isRecording = false; let currentProductData = null; let micPermissionGranted = false;

        function initApp() { document.getElementById('start-overlay').classList.add('hidden'); startCamera(); }
        function toggleHelpModal() { const el = document.getElementById('help-modal'); el.classList.toggle('hidden'); }
        function showError(msg) { 
            const toast = document.getElementById('error-toast'); 
            if(toast) {
                document.getElementById('error-message').innerText = msg; 
                toast.classList.remove('hidden', '-translate-y-full', 'opacity-0'); 
                setTimeout(() => { toast.classList.add('-translate-y-full', 'opacity-0'); setTimeout(() => toast.classList.add('hidden'), 300); }, 5000); 
            } else { alert(msg); }
        }

        async function startCamera() {
            if (isRecording) return;
            try {
                const videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facingMode, width: { ideal: 1080 }, height: { ideal: 1080 } }, audio: false });
                stream = videoStream;
                const videoEl = document.getElementById('camera-feed'); videoEl.srcObject = videoStream; videoEl.muted = true;
                
                try {
                    const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    micPermissionGranted = true;
                    let options = {};
                    if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) options = { mimeType: 'audio/webm;codecs=opus', audioBitsPerSecond: 128000 };
                    else if (MediaRecorder.isTypeSupported('audio/mp4')) options = { mimeType: 'audio/mp4', audioBitsPerSecond: 128000 };
                    mediaRecorder = new MediaRecorder(audioStream, options);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = async () => { const mimeType = mediaRecorder.mimeType || 'audio/webm'; const audioBlob = new Blob(audioChunks, { type: mimeType }); await processAudioChain(audioBlob); };
                    enableMicUI();
                } catch (audioErr) { micPermissionGranted = false; disableMicUI("Mikrofon izni yok."); }
            } catch (videoErr) { document.getElementById('camera-permission-warning').classList.remove('hidden'); showError("Kamera izni yok."); }
        }
        
        function disableMicUI(msg) { const btn = document.getElementById('record-btn'); const icn = document.getElementById('mic-icon'); const txt = document.getElementById('live-transcript'); btn.classList.add('opacity-50', 'grayscale'); icn.classList.replace('ph-microphone', 'ph-microphone-slash'); txt.innerText = msg; }
        function enableMicUI() { const btn = document.getElementById('record-btn'); const icn = document.getElementById('mic-icon'); const txt = document.getElementById('live-transcript'); btn.classList.remove('opacity-50', 'grayscale'); icn.classList.replace('ph-microphone-slash', 'ph-microphone'); txt.innerText = '"Zara oversize gömlek, Mavi renk, 300 TL..."'; }
        
        function switchCamera() { if(stream) { stream.getTracks().forEach(track => track.stop()); } facingMode = facingMode === "environment" ? "user" : "environment"; startCamera(); }
        
        function takePhoto() {
            const video = document.getElementById('camera-feed'); const canvas = document.getElementById('capture-canvas');
            const targetRatio = 2/3; const videoRatio = video.videoWidth / video.videoHeight;
            let sW, sH, sX, sY;
            if (videoRatio > targetRatio) { sH = video.videoHeight; sW = sH * targetRatio; sX = (video.videoWidth - sW) / 2; sY = 0; } 
            else { sW = video.videoWidth; sH = sW / targetRatio; sX = 0; sY = (video.videoHeight - sH) / 2; }
            canvas.width = 1000; canvas.height = 1500;
            const ctx = canvas.getContext('2d'); ctx.drawImage(video, sX, sY, sW, sH, 0, 0, 1000, 1500);
            const data = canvas.toDataURL('image/jpeg', 0.85);
            const index = photos.length;
            photos.push({ original: data, processed: data, status: 'done' });
            video.style.opacity = "0.5"; setTimeout(() => video.style.opacity = "0.9", 150);
            document.getElementById('gallery-wrapper').classList.remove('hidden');
            const div = document.createElement('div'); div.id = `photo-item-${index}`; div.className = "relative flex-shrink-0 w-10 h-14 rounded-lg overflow-hidden border-2 border-white/50 shadow-md snap-start"; 
            div.innerHTML = `<img src="${data}" class="w-full h-full object-cover"><button onclick="removePhoto(this, ${index})" class="absolute inset-0 bg-black/20 flex items-center justify-center text-white opacity-0 hover:opacity-100 transition-opacity"><i class="ph ph-trash"></i></button>`;
            document.getElementById('gallery-strip').appendChild(div);
        }
        function removePhoto(el, index) { el.parentElement.remove(); photos[index] = null; if(photos.filter(p => p !== null).length === 0) document.getElementById('gallery-wrapper').classList.add('hidden'); }

        function toggleRecording() {
            if(!micPermissionGranted) { showError("Mikrofon izni yok!"); return; }
            if (isRecording) { if(mediaRecorder.state === 'recording') { mediaRecorder.stop(); isRecording = false; updateRecordingUI(false); } }
            else { if(mediaRecorder.state === 'inactive') { audioChunks = []; mediaRecorder.start(); isRecording = true; updateRecordingUI(true); } }
        }

        function updateRecordingUI(active) {
            const btn = document.getElementById('record-btn'); const prompt = document.getElementById('recorder-prompt'); const micIcon = document.getElementById('mic-icon'); const indicator = document.getElementById('recording-indicator');
            if (active) { btn.classList.add('recording-pulse', 'scale-110'); micIcon.classList.replace('ph-microphone', 'ph-stop'); prompt.innerText = "DURDUR VE GÖNDER"; prompt.classList.add('text-red-500'); indicator.classList.remove('hidden'); }
            else { btn.classList.remove('recording-pulse', 'scale-110'); micIcon.classList.replace('ph-stop', 'ph-microphone'); prompt.innerText = "DOKUN VE KONUŞ"; prompt.classList.remove('text-red-500'); indicator.classList.add('hidden'); }
        }

        async function processAudioChain(audioBlob) {
            const cleanKey = API_ANAHTARI.trim().replace(/\s/g, ''); 
            if (cleanKey.includes("BURAYA")) { showError("API Key girilmemiş."); return; }
            if (audioBlob.size === 0) { showError("Ses yok."); return; }

            document.getElementById('loading-overlay').classList.remove('hidden');
            const fileExt = audioBlob.type.includes('mp4') ? 'mp4' : 'webm';
            const formData = new FormData(); formData.append("file", audioBlob, `recording.${fileExt}`); formData.append("model", "whisper-1"); formData.append("language", "tr");
            formData.append("prompt", "Tedarikçi: Ahmet Tekstil, Mehmet Giyim. Marka: Zara, Bershka, H&M, Pull&Bear, Stradivarius, Mavi, Nike, Adidas. Kategori: Sweatshirt, Tişört, Pantolon, Gömlek, Ceket, Elbise, Etek, Jean. Özellik: Oversize, Slim Fit, Regular, Şardonlu, İki İplik, Pamuk, Viskon. Beden: S, M, L, XL, XXL, 36, 38, 40, 42. Durum: Defolu, Etiketi Kesik, Seri Sonu. Fiyat: TL, Lira.");

            try {
                const whisperRes = await fetch("https://api.openai.com/v1/audio/transcriptions", { method: "POST", headers: { "Authorization": `Bearer ${cleanKey}` }, body: formData });
                if (!whisperRes.ok) throw new Error("Whisper Hatası");
                const whisperData = await whisperRes.json();
                
                document.getElementById('loading-title').innerText = "Analiz Ediliyor...";
                
                // YENİ PROMPT (Renk ve Beden Ayrıldı)
                const systemPrompt = `Sen e-ticaret uzmanısın. Ses kaydını analiz et.
                    KURALLAR: 1. Kalıp: Oversize -> "Bol Kesim (Oversize)", Slim Fit -> "Dar Kesim". 2. Başlık: "Marka + Kalıp + Ürün Tipi".
                    JSON: {"tedarikci": "...", "marka": "...", "kategori": "...", "cinsiyet": "...", "kalip": "...", "renk": "...", "beden": "...", "urun_basligi": "...", "satis_fiyati": "...", "piyasa_fiyati": "...", "stok": "...", "kusur_detayi": "...", "aciklama": "..."}`;

                const gptRes = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${cleanKey}` },
                    body: JSON.stringify({ model: "gpt-4o-mini", messages: [ { role: "system", content: systemPrompt }, { role: "user", content: whisperData.text } ], response_format: { type: "json_object" }, temperature: 0.3 })
                });
                const gptData = await gptRes.json();
                currentProductData = JSON.parse(gptData.choices[0].message.content);
                
                document.getElementById('res-baslik').innerText = currentProductData.urun_basligi;
                document.getElementById('res-tedarikci-marka').innerText = `${currentProductData.tedarikci} / ${currentProductData.marka}`;
                document.getElementById('res-kategori').innerText = currentProductData.kategori;
                document.getElementById('res-fiyat').innerText = currentProductData.satis_fiyati;
                document.getElementById('res-piyasa-fiyat').innerText = currentProductData.piyasa_fiyati;
                document.getElementById('res-aciklama').innerText = currentProductData.aciklama;
                
                // AYRILMIŞ ALANLAR (UI'da Ayrı Gösteriliyor)
                document.getElementById('res-renk').innerText = currentProductData.renk;
                document.getElementById('res-beden').innerText = currentProductData.beden;
                document.getElementById('res-kalip').innerText = currentProductData.kalip;
                document.getElementById('res-stok').innerText = currentProductData.stok;
                document.getElementById('res-kusur').innerText = currentProductData.kusur_detayi;

                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('success-modal').classList.remove('hidden');
            } catch (error) { document.getElementById('loading-overlay').classList.add('hidden'); showError("Hata: " + error.message); }
        }

        // --- WEBHOOK GÖNDERME (GÜNCELLENDİ: Güvenli DOM & Renk/Beden Ayrı) ---
        async function sendDataToWebhook() {
            if (!currentProductData) return;
            const btn = document.getElementById('final-send-btn'); 
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="ph ph-spinner animate-spin text-xl"></i> Gönderiliyor...`; 
            btn.disabled = true;
            
            // Payload Güncellendi (renk ve beden ayrı)
            const payload = {
                tedarikci: currentProductData.tedarikci,
                marka: currentProductData.marka,
                kategori: currentProductData.kategori,
                cinsiyet: currentProductData.cinsiyet,
                kalip: currentProductData.kalip,
                renk: currentProductData.renk, // Ayrı
                beden: currentProductData.beden, // Ayrı
                urun_basligi: currentProductData.urun_basligi,
                satis_fiyati: currentProductData.satis_fiyati,
                piyasa_fiyati: currentProductData.piyasa_fiyati,
                stok: currentProductData.stok,
                kusur_detayi: currentProductData.kusur_detayi,
                aciklama: currentProductData.aciklama,
                gorsel: photos[0] ? photos[0].processed : null
            };

            try {
                const response = await fetch(WEBHOOK_URL.trim().replace(/\s/g, ''), { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorText = await response.text(); throw new Error("Sunucu Hatası: " + response.status + " " + errorText); }
                
                // GÜVENLİ DOM ERİŞİMİ (NULL CHECK)
                const successModal = document.getElementById('success-modal');
                const successOverlay = document.getElementById('email-success-overlay');
                
                if(successModal) successModal.classList.add('hidden');
                
                if(successOverlay) {
                    successOverlay.classList.remove('hidden');
                    setTimeout(() => { 
                        successOverlay.classList.add('hidden'); 
                        resetApp(); 
                    }, 2000);
                } else {
                    // Eğer overlay bulunamazsa basit alert ile devam et (çökme önleyici)
                    alert("Gönderildi!");
                    resetApp();
                }
            } catch (e) { 
                console.error(e); 
                showError("Gönderim Hatası: " + e.message); 
                btn.innerHTML = originalText; 
                btn.disabled = false; 
            }
        }

        function resetApp() { 
            photos = []; 
            const galleryStrip = document.getElementById('gallery-strip');
            const galleryWrapper = document.getElementById('gallery-wrapper');
            const successModal = document.getElementById('success-modal');
            
            if(galleryStrip) galleryStrip.innerHTML = ''; 
            if(galleryWrapper) galleryWrapper.classList.add('hidden'); 
            currentProductData = null; 
            if(successModal) successModal.classList.add('hidden'); 
        }
    </script>
</body>
</html>
