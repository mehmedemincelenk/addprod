<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hızlı Ürün Yükle - Faz 1 (Analiz)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b; /* Zinc 950 */
            color: white;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
            touch-action: none;
        }

        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }

        .recording-pulse {
            animation: pulse-red 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
    </style>
</head>

<body class="flex flex-col h-[100dvh] w-full relative">

    <!-- GİRİŞ EKRANI -->
    <div id="start-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-[#09090b] text-white p-8 text-center">
        <div class="w-24 h-24 bg-zinc-800/50 rounded-full flex items-center justify-center mb-8 shadow-2xl border border-white/5 relative">
            <div class="absolute inset-0 rounded-full bg-blue-500/10 blur-xl"></div>
            <i class="ph ph-camera text-4xl text-blue-400 relative z-10"></i>
        </div>
        <h3 class="text-3xl font-bold mb-3 tracking-tight">Hoş Geldiniz</h3>
        <p class="text-zinc-400 mb-10 max-w-xs text-sm leading-relaxed font-medium">Hızlı ürün yüklemek için kamera ve ses erişimine izin verin.</p>
        <button onclick="initApp()" class="w-full max-w-[200px] py-4 bg-white text-black rounded-2xl font-bold text-lg hover:bg-zinc-200 active:scale-95 transition-all flex items-center justify-center gap-2 shadow-lg shadow-white/5">
            Başla
            <i class="ph ph-arrow-right font-bold"></i>
        </button>
    </div>

    <!-- ÜST PANEL -->
    <header class="absolute top-0 left-0 right-0 z-30 safe-pt p-4 flex justify-between items-center pointer-events-none">
        <button onclick="alert('Önce fotoğraf çekin, sonra kırmızı butona basıp ürünü anlatın.')" class="pointer-events-auto w-10 h-10 rounded-full glass flex items-center justify-center text-white/80">
            <i class="ph ph-question text-xl"></i>
        </button>

        <div class="glass px-4 py-1.5 rounded-full">
            <span class="text-xs font-semibold text-white/90 tracking-wide uppercase">Faz 1: Analiz Modu</span>
        </div>

        <button onclick="switchCamera()" class="pointer-events-auto w-10 h-10 rounded-full glass flex items-center justify-center text-white/80">
            <i class="ph ph-arrows-clockwise text-xl"></i>
        </button>
    </header>

    <!-- KAMERA EKRANI -->
    <div class="flex-1 relative flex flex-col justify-center items-center overflow-hidden bg-[#09090b]">
        <div class="relative w-full aspect-[2/3] max-h-[85vh] bg-zinc-900 rounded-[2rem] overflow-hidden shadow-2xl mx-4 border border-white/5">
            <video id="camera-feed" autoplay playsinline muted class="w-full h-full object-cover opacity-90"></video>
            
            <div id="camera-permission-warning" class="hidden absolute inset-0 flex flex-col items-center justify-center p-6 text-center bg-zinc-900/95 backdrop-blur-sm z-30">
                <i class="ph ph-lock-key text-4xl text-zinc-500 mb-4"></i>
                <h3 class="text-white font-bold mb-2">İzin Gerekli</h3>
                <p class="text-xs text-zinc-400 mb-6">Ayarlardan kamera ve mikrofonu açın.</p>
                <button onclick="initApp()" class="px-6 py-2 bg-white text-black rounded-full font-bold text-xs">Tekrar Dene</button>
            </div>

            <div class="absolute bottom-4 left-4 right-4 flex justify-between items-end">
                <div id="gallery-wrapper" class="hidden">
                    <div id="gallery-strip" class="flex gap-2 overflow-x-auto hide-scrollbar p-1"></div>
                </div>
                
                <button onclick="takePhoto()" class="ml-auto w-14 h-14 rounded-full border-[3px] border-white/80 bg-white/20 backdrop-blur-sm flex items-center justify-center active:scale-95 transition-transform shadow-lg">
                    <div class="w-10 h-10 bg-white rounded-full"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- ALT KONTROL PANELİ -->
    <div class="bg-[#09090b] text-white pt-6 px-6 pb-8 safe-pb z-20 flex flex-col gap-6 relative rounded-t-[2rem] border-t border-white/5">
        <div class="absolute top-3 left-1/2 -translate-x-1/2 w-12 h-1 bg-zinc-800 rounded-full"></div>

        <div class="flex items-center gap-5 mt-2 justify-center">
            <button id="record-btn" onclick="toggleRecording()" class="shrink-0 w-20 h-20 bg-red-600 text-white rounded-[2rem] flex items-center justify-center shadow-lg shadow-red-900/20 active:scale-95 transition-all relative overflow-hidden group select-none">
                <div class="absolute inset-0 bg-gradient-to-tr from-red-600 to-red-500"></div>
                <i id="mic-icon" class="ph ph-microphone text-3xl z-10 relative text-white"></i>
            </button>

            <div class="flex-1 max-w-[200px] flex flex-col justify-center h-20">
                <div class="flex justify-between items-center mb-1.5">
                    <span id="recorder-prompt" class="text-[10px] font-bold text-zinc-400 uppercase tracking-wider">DOKUN VE KONUŞ</span>
                    <div id="recording-indicator" class="hidden flex items-center gap-1.5 px-2 py-0.5 bg-red-500/10 rounded-full border border-red-500/20">
                        <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span>
                        <span class="text-[9px] font-bold text-red-500 uppercase">Dinliyor</span>
                    </div>
                </div>
                <p id="live-transcript" class="text-sm text-zinc-300 font-medium leading-snug line-clamp-2 transition-colors italic">"Zara oversize gömlek, Mavi, 300 TL..."</p>
            </div>
        </div>
    </div>

    <!-- YÜKLEME VE SONUÇ MODALLARI -->
    <div id="loading-overlay" class="fixed inset-0 bg-[#09090b]/90 z-[60] hidden flex flex-col items-center justify-center text-white p-6 text-center backdrop-blur-md">
        <div class="relative mb-6">
            <div class="w-16 h-16 border-4 border-zinc-800 border-t-blue-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center"><i class="ph ph-sparkle text-blue-500 animate-pulse"></i></div>
        </div>
        <h3 class="text-xl font-bold mb-2" id="loading-title">AI Ürünü Hazırlıyor...</h3>
        <p class="text-sm text-zinc-400 animate-pulse" id="loading-text">Ses verisi çözümleniyor...</p>
    </div>

    <div id="success-modal" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center p-4 sm:p-6 bg-black/90 backdrop-blur-sm">
        <div class="bg-zinc-900 border border-white/10 w-full max-w-sm rounded-[2rem] p-5 relative z-10 shadow-2xl flex flex-col max-h-[85vh]">
            <div class="text-center mb-5 shrink-0">
                <div class="w-12 h-12 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center mx-auto mb-3"><i class="ph ph-check text-2xl font-bold"></i></div>
                <h3 class="text-lg font-bold text-white">Analiz Tamamlandı</h3>
            </div>
            <div class="flex-1 overflow-y-auto space-y-3 mb-6 pr-1 custom-scrollbar" id="result-fields">
                <!-- Veriler buraya dolacak -->
                <div class="bg-black/40 p-3 rounded-xl border border-white/5"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Başlık</p><p id="res-baslik" class="text-sm font-bold text-white leading-tight">-</p></div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-black/40 p-3 rounded-xl border border-white/5"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Marka</p><p id="res-marka" class="text-sm text-zinc-200 truncate">-</p></div>
                    <div class="bg-black/40 p-3 rounded-xl border border-white/5"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Kategori</p><p id="res-kategori" class="text-sm text-zinc-200 truncate">-</p></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-black/40 p-3 rounded-xl border border-white/5"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Renk</p><p id="res-renk" class="text-sm text-zinc-200 truncate">-</p></div>
                    <div class="bg-black/40 p-3 rounded-xl border border-white/5"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Beden</p><p id="res-beden" class="text-sm text-zinc-200 truncate">-</p></div>
                </div>
                <div class="bg-green-500/10 p-3 rounded-xl border border-green-500/20"><p class="text-[10px] text-green-500 uppercase font-bold mb-1">Fiyat</p><p id="res-fiyat" class="text-lg font-bold text-green-400">-</p></div>
            </div>
            <div class="space-y-3 shrink-0">
                <button onclick="sendDataToWebhook()" id="final-send-btn" class="w-full bg-white text-black py-4 rounded-xl font-bold text-base shadow-lg hover:bg-zinc-200 active:scale-95 transition-all flex items-center justify-center gap-2"><span>Onayla ve Kaydet</span><i class="ph ph-paper-plane-tilt font-bold"></i></button>
                <button onclick="resetApp()" class="w-full bg-transparent text-zinc-400 py-3 rounded-xl font-medium text-sm hover:text-white transition-colors">İptal</button>
            </div>
        </div>
    </div>

    <canvas id="capture-canvas" class="hidden"></canvas>

    <script>
        // --- WEBHOOK YAPILANDIRMASI ---
        const WEBHOOK_URL = "https://hook.eu1.make.com/uav81dlsk6p0ibimh6t3jmg5o4xcowhi";

        let photos = []; 
        let stream = null; 
        let facingMode = "environment"; 
        let mediaRecorder = null; 
        let audioChunks = []; 
        let isRecording = false; 
        let currentProductData = null; 
        let micPermissionGranted = false;

        function initApp() {
            document.getElementById('start-overlay').classList.add('hidden');
            startCamera();
        }

        async function startCamera() {
            try {
                if (stream) stream.getTracks().forEach(t => t.stop());
                const vStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: facingMode, width: { ideal: 1080 }, height: { ideal: 1080 } }, 
                    audio: false 
                });
                stream = vStream;
                document.getElementById('camera-feed').srcObject = vStream;
                
                try {
                    const aStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    micPermissionGranted = true;
                    setupRecorder(aStream);
                } catch (e) { micPermissionGranted = false; }
            } catch (e) { document.getElementById('camera-permission-warning').classList.remove('hidden'); }
        }

        function setupRecorder(audioStream) {
            let options = { mimeType: 'audio/webm;codecs=opus' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'audio/mp4' };
            mediaRecorder = new MediaRecorder(audioStream, options);
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                await processAudioChain(audioBlob);
            };
        }

        function toggleRecording() {
            if(!micPermissionGranted) { alert("Mikrofon izni gerek."); return; }
            if (isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                updateRecordingUI(false);
            } else {
                audioChunks = [];
                mediaRecorder.start();
                isRecording = true;
                updateRecordingUI(true);
            }
        }

        function updateRecordingUI(active) {
            const btn = document.getElementById('record-btn');
            const indicator = document.getElementById('recording-indicator');
            if (active) {
                btn.classList.add('recording-pulse', 'scale-110');
                indicator.classList.remove('hidden');
                document.getElementById('recorder-prompt').innerText = "DURDUR VE ANALİZ ET";
            } else {
                btn.classList.remove('recording-pulse', 'scale-110');
                indicator.classList.add('hidden');
                document.getElementById('recorder-prompt').innerText = "DOKUN VE KONUŞ";
            }
        }

        // --- FAZ 1: ANALİZ FONKSİYONU ---
        async function processAudioChain(audioBlob) {
            if (audioBlob.size === 0) return;

            const overlay = document.getElementById('loading-overlay');
            overlay.classList.remove('hidden');

            const formData = new FormData();
            formData.append("file", audioBlob, "recording.webm");

            try {
                // Make.com Analiz Senaryosuna (Senaryo A) sesi gönderiyoruz
                const response = await fetch(WEBHOOK_URL, { 
                    method: "POST", 
                    body: formData 
                });
                
                if (!response.ok) throw new Error("Webhook yanıt vermedi.");
                
                // Senaryodan GPT çıktısı olan JSON bekleniyor
                const data = await response.json();
                currentProductData = data; 

                // UI Verilerini Doldur
                document.getElementById('res-baslik').innerText = data.urun_basligi || "-";
                document.getElementById('res-marka').innerText = data.marka || "-";
                document.getElementById('res-kategori').innerText = data.kategori || "-";
                document.getElementById('res-fiyat').innerText = data.satis_fiyati || "-";
                document.getElementById('res-renk').innerText = data.renk || "-";
                document.getElementById('res-beden').innerText = data.beden || "-";

                overlay.classList.add('hidden');
                document.getElementById('success-modal').classList.remove('hidden');
            } catch (e) {
                overlay.classList.add('hidden');
                alert("Analiz Hatası: " + e.message);
            }
        }

        async function sendDataToWebhook() {
            if (!currentProductData) return;
            const btn = document.getElementById('final-send-btn');
            btn.disabled = true;
            btn.innerHTML = `<i class="ph ph-spinner animate-spin"></i> Kaydediliyor...`;

            const payload = {
                ...currentProductData,
                gorsel: photos[0] ? photos[0].processed : null,
                action: "SAVE_PRODUCT"
            };

            try {
                // Veriyi kaydetmek için tekrar aynı veya farklı bir webhook çağrılabilir
                await fetch(WEBHOOK_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                
                alert("Başarıyla kaydedildi!");
                resetApp();
            } catch (e) {
                alert("Kayıt hatası!");
                btn.disabled = false;
                btn.innerHTML = "Onayla ve Kaydet";
            }
        }

        function takePhoto() {
            const video = document.getElementById('camera-feed');
            const canvas = document.getElementById('capture-canvas');
            canvas.width = 1000; canvas.height = 1500;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, 1000, 1500);
            const data = canvas.toDataURL('image/jpeg', 0.8);
            
            photos.unshift({ processed: data });
            updateGallery();
            video.style.opacity = "0.5";
            setTimeout(() => video.style.opacity = "0.9", 100);
        }

        function updateGallery() {
            const strip = document.getElementById('gallery-strip');
            strip.innerHTML = '';
            if(photos.length > 0) {
                document.getElementById('gallery-wrapper').classList.remove('hidden');
                photos.forEach((p) => {
                    const div = document.createElement('div');
                    div.className = "shrink-0 w-10 h-14 rounded-lg overflow-hidden border border-white/30";
                    div.innerHTML = `<img src="${p.processed}" class="w-full h-full object-cover">`;
                    strip.appendChild(div);
                });
            }
        }

        function resetApp() {
            photos = []; currentProductData = null;
            document.getElementById('gallery-wrapper').classList.add('hidden');
            document.getElementById('success-modal').classList.add('hidden');
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function switchCamera() {
            facingMode = facingMode === "environment" ? "user" : "environment";
            startCamera();
        }
    </script>
</body>
</html>
