<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lojistik V4 - Akıllı Ürün Yükle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #09090b; color: white; -webkit-tap-highlight-color: transparent; overflow: hidden; touch-action: none; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .recording-pulse { animation: pulse-red 2s infinite cubic-bezier(0.4, 0, 0.6, 1); }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .glass { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
    </style>
</head>

<body class="flex flex-col h-[100dvh] w-full relative">

    <div id="start-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-[#09090b] p-8 text-center">
        <div class="w-20 h-20 bg-blue-500/10 rounded-3xl flex items-center justify-center mb-6 border border-blue-500/20">
            <i class="ph ph-package text-4xl text-blue-400"></i>
        </div>
        <h3 class="text-2xl font-bold mb-2">Lojistik V4</h3>
        <p class="text-zinc-500 mb-8 text-sm max-w-[240px]">Fotoğraf çek, anlat, AI senin için dükkanı doldursun.</p>
        <button onclick="initApp()" class="w-full max-w-[180px] py-4 bg-white text-black rounded-2xl font-bold active:scale-95 transition-all shadow-xl">Başla</button>
    </div>

    <header class="absolute top-0 left-0 right-0 z-30 safe-pt p-4 flex justify-between items-center pointer-events-none">
        <div class="glass px-4 py-1.5 rounded-full pointer-events-auto">
            <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">AI Lojistik Hattı</span>
        </div>
        <button onclick="switchCamera()" class="pointer-events-auto w-10 h-10 rounded-full glass flex items-center justify-center">
            <i class="ph ph-arrows-clockwise text-xl"></i>
        </button>
    </header>

    <div class="flex-1 relative flex flex-col justify-center items-center overflow-hidden bg-black">
        <video id="camera-feed" autoplay playsinline muted class="w-full h-full object-cover opacity-80"></video>
        
        <div class="absolute bottom-6 left-6 right-6 flex justify-between items-center">
            <div id="gallery-wrapper" class="hidden glass p-1 rounded-xl">
                <div id="gallery-strip" class="w-12 h-16 rounded-lg overflow-hidden border border-white/20"></div>
            </div>
            <button onclick="takePhoto()" class="w-16 h-16 rounded-full border-4 border-white/30 bg-white/10 flex items-center justify-center active:scale-90 transition-all">
                <div class="w-12 h-12 bg-white rounded-full shadow-inner"></div>
            </button>
        </div>
    </div>

    <div class="bg-zinc-950 pt-4 px-6 pb-8 safe-pb border-t border-white/5">
        <div class="flex items-center gap-4">
            <button id="record-btn" onclick="toggleRecording()" class="shrink-0 w-16 h-16 bg-red-600 rounded-2xl flex items-center justify-center active:scale-90 transition-all">
                <i id="mic-icon" class="ph ph-microphone text-2xl"></i>
            </button>
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <span id="recorder-prompt" class="text-[9px] font-black text-zinc-500 uppercase tracking-tighter">Sistemi Dinle</span>
                    <div id="recording-indicator" class="hidden w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                </div>
                <p id="live-transcript" class="text-xs text-zinc-400 italic line-clamp-2 leading-relaxed">"Siyah oversize tişört, XL, 250 TL..."</p>
            </div>
        </div>
    </div>

    <div id="success-modal" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center p-4 bg-black/90 backdrop-blur-md">
        <div class="bg-zinc-900 border border-white/10 w-full max-w-sm rounded-[2.5rem] p-6 shadow-2xl flex flex-col max-h-[80vh]">
            
            <div class="flex items-center gap-3 mb-4">
                <div id="res-kategori-tag" class="px-3 py-1 bg-blue-500/10 border border-blue-500/20 rounded-full text-[10px] font-bold text-blue-400 uppercase">Kategori</div>
                <div class="flex-1 h-px bg-white/5"></div>
            </div>

            <h3 id="res-baslik" class="text-xl font-bold text-white mb-4 leading-tight leading-snug">-</h3>
            
            <div class="flex-1 overflow-y-auto space-y-4 custom-scrollbar mb-6 pr-1">
                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-white/5 p-2 rounded-xl text-center">
                        <p class="text-[8px] text-zinc-500 uppercase font-bold mb-1">Renk</p>
                        <p id="res-renk" class="text-[11px] font-medium">-</p>
                    </div>
                    <div class="bg-white/5 p-2 rounded-xl text-center">
                        <p class="text-[8px] text-zinc-500 uppercase font-bold mb-1">Beden</p>
                        <p id="res-beden" class="text-[11px] font-medium">-</p>
                    </div>
                    <div class="bg-white/5 p-2 rounded-xl text-center">
                        <p class="text-[8px] text-zinc-500 uppercase font-bold mb-1">Kalıp</p>
                        <p id="res-kalip" class="text-[11px] font-medium">-</p>
                    </div>
                </div>

                <div class="bg-black/30 p-4 rounded-2xl border border-white/5">
                    <p class="text-[9px] text-zinc-500 uppercase font-bold mb-2 tracking-widest">AI Satış Açıklaması</p>
                    <p id="res-aciklama" class="text-xs text-zinc-300 leading-relaxed italic overflow-hidden"></p>
                </div>

                <div class="flex justify-between items-center bg-green-500/5 p-3 rounded-xl border border-green-500/10">
                    <span class="text-[10px] font-bold text-green-500 uppercase">Satış Fiyatı</span>
                    <span id="res-fiyat" class="text-lg font-black text-green-400">-</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 shrink-0">
                <button onclick="resetApp()" class="py-4 rounded-2xl bg-zinc-800 text-zinc-400 font-bold text-sm">İptal</button>
                <button onclick="sendDataToWebhook()" id="final-send-btn" class="py-4 rounded-2xl bg-white text-black font-bold text-sm shadow-lg active:scale-95 transition-all">Onayla</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 bg-black/95 z-[60] hidden flex flex-col items-center justify-center text-center p-10">
        <div class="w-12 h-12 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-sm font-bold tracking-widest text-zinc-400 animate-pulse">AI ANALİZ EDİYOR...</p>
    </div>

    <div id="error-toast" class="fixed top-6 inset-x-6 bg-red-600 text-white p-4 rounded-2xl z-[80] hidden flex items-center gap-3 shadow-2xl">
        <i class="ph ph-warning text-xl"></i>
        <span id="error-message" class="text-xs font-bold">Hata</span>
    </div>

    <canvas id="capture-canvas" class="hidden"></canvas>

    <script>
        const ANALIZ_WEBHOOK_URL = "https://hook.eu1.make.com/yi311van8k36hcpvtp3tro73icby58qo";
        const KAYIT_WEBHOOK_URL = "https://hook.eu1.make.com/6sb60xary7l6xxitq567ertlzfamwumd"; 

        let photos = []; let stream = null; let facingMode = "environment"; let mediaRecorder = null; 
        let audioChunks = []; let isRecording = false; let currentProductData = null;

        function initApp() { document.getElementById('start-overlay').classList.add('hidden'); startCamera(); }

        async function startCamera() {
            try {
                if (stream) stream.getTracks().forEach(t => t.stop());
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facingMode, width: 1080 } });
                document.getElementById('camera-feed').srcObject = stream;
                const aStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                setupRecorder(aStream);
            } catch (e) { showError("Kamera/Mikrofon izni gerek."); }
        }

        function setupRecorder(s) {
            mediaRecorder = new MediaRecorder(s);
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                processAudioChain(blob);
            };
        }

        function toggleRecording() {
            if (isRecording) {
                mediaRecorder.stop(); isRecording = false;
                document.getElementById('record-btn').classList.remove('recording-pulse');
                document.getElementById('recording-indicator').classList.add('hidden');
            } else {
                audioChunks = []; mediaRecorder.start(); isRecording = true;
                document.getElementById('record-btn').classList.add('recording-pulse');
                document.getElementById('recording-indicator').classList.remove('hidden');
            }
        }

        async function processAudioChain(blob) {
            document.getElementById('loading-overlay').classList.remove('hidden');
            const fd = new FormData(); fd.append("file", blob, "rec.webm");
            try {
                const res = await fetch(ANALIZ_WEBHOOK_URL, { method: "POST", body: fd });
                const data = await res.json();
                currentProductData = data;

                document.getElementById('res-baslik').innerText = data.urun_basligi || "-";
                document.getElementById('res-kategori-tag').innerText = data.kategori || "GENEL";
                document.getElementById('res-renk').innerText = data.renk || "-";
                document.getElementById('res-beden').innerText = data.beden || "-";
                document.getElementById('res-kalip').innerText = data.kalip || "-";
                document.getElementById('res-aciklama').innerText = data.aciklama || "Açıklama oluşturulamadı.";
                document.getElementById('res-fiyat').innerText = (data.satis_fiyati || "-") + " TL";

                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('success-modal').classList.remove('hidden');
            } catch (e) { document.getElementById('loading-overlay').classList.add('hidden'); showError("Hata: " + e.message); }
        }

        async function sendDataToWebhook() {
            const btn = document.getElementById('final-send-btn');
            btn.disabled = true; btn.innerText = "Yükleniyor...";
            const payload = { ...currentProductData, gorsel_data: photos[0]?.processed, islem_tarihi: new Date().toISOString() };
            try {
                await fetch(KAYIT_WEBHOOK_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                location.reload();
            } catch (e) { showError("Kayıt hatası!"); btn.disabled = false; btn.innerText = "Onayla"; }
        }

        function takePhoto() {
            const v = document.getElementById('camera-feed');
            const c = document.getElementById('capture-canvas');
            c.width = 800; c.height = 1000;
            c.getContext('2d').drawImage(v, 0, 0, 800, 1000);
            photos = [{ processed: c.toDataURL('image/jpeg', 0.8) }];
            document.getElementById('gallery-strip').innerHTML = `<img src="${photos[0].processed}" class="w-full h-full object-cover">`;
            document.getElementById('gallery-wrapper').classList.remove('hidden');
        }

        function resetApp() { document.getElementById('success-modal').classList.add('hidden'); }
        function switchCamera() { facingMode = facingMode === "environment" ? "user" : "environment"; startCamera(); }
        function showError(m) { const t = document.getElementById('error-toast'); document.getElementById('error-message').innerText = m; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }
    </script>
</body>
</html>
